# 充电桩管理系统部署说明

## 一、系统要求

1. **操作系统**：Windows 10/11 或 Windows Server 2016/2019/2022
2. **依赖软件**：
   - .NET 9.0（或对应版本）运行时（如果不是自包含部署）
   - PostgreSQL 数据库（如果使用本地数据库）
   - PostGIS 扩展（如果使用本地数据库）

## 二、部署步骤

### 1. 准备服务器

- 确保服务器满足系统要求
- 如果不是自包含部署，需要安装 .NET 运行时

### 2. 配置数据库

**选项A：使用现有云数据库**
- 使用当前`appsettings.json`中的连接字符串（默认已配置Neon云数据库）

**选项B：使用本地PostgreSQL数据库**
1. 安装PostgreSQL 14或更高版本
2. 安装PostGIS扩展
3. 创建数据库并导入数据结构：
   ```
   psql -U postgres -c "CREATE DATABASE charging_pile_db;"
   psql -U postgres -d charging_pile_db -f ChargingPileDb.sql
   ```
4. 修改`appsettings.json`中的数据库连接字符串：
   ```json
   "ConnectionStrings": {
     "DefaultConnection": "Host=localhost;Database=charging_pile_db;Username=postgres;Password=你的密码;SSL Mode=Prefer;"
   }
   ```

### 3. 配置应用设置

1. 检查并根据需要修改`appsettings.json`中的设置：
   - TCP服务器监听地址和端口
   - 日志级别
   - JWT设置（在生产环境中更改Secret）
   - 微信小程序AppID和AppSecret（如果需要）

### 4. 启动应用

**方法一：直接运行**
```
ChargingPile.API.exe
```

**方法二：使用命令行参数**
```
ChargingPile.API.exe --urls="http://*:5000"
```

**方法三：创建Windows服务**

使用NSSM工具创建Windows服务：
1. 下载NSSM：https://nssm.cc/download
2. 通过以下命令安装服务：
```
nssm.exe install ChargingPileService "C:\path\to\ChargingPile.API.exe"
nssm.exe set ChargingPileService AppDirectory "C:\path\to"
nssm.exe set ChargingPileService Description "充电桩管理系统"
nssm.exe set ChargingPileService Start SERVICE_AUTO_START
nssm.exe start ChargingPileService
```

## 三、验证部署

1. 访问 `http://服务器IP:5000/swagger` 查看API文档
2. 使用客户端工具测试TCP连接（端口默认为8057）

## 四、防火墙设置

确保以下端口在防火墙中开放：
- 5000（HTTP API）
- 8057（TCP服务器）

在PowerShell中运行以下命令：
```powershell
netsh advfirewall firewall add rule name="ChargingPileAPI-HTTP" dir=in action=allow protocol=TCP localport=5000
netsh advfirewall firewall add rule name="ChargingPileAPI-TCP" dir=in action=allow protocol=TCP localport=8057
```

## 五、故障排除

1. **应用无法启动**
   - 检查日志文件
   - 确认权限是否正确
   - 确认端口是否被占用

2. **数据库连接失败**
   - 检查连接字符串
   - 确认数据库服务是否运行
   - 确认网络连接和防火墙设置

3. **TCP连接问题**
   - 检查防火墙设置
   - 确认TCP端口配置
   - 检查网络地址配置

如有更多问题，请参考项目文档或联系技术支持。 