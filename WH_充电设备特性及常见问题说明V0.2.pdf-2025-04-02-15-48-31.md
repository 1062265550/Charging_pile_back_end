## 充电桩协议对接以及常见问题说明

V0.2

<table><tr><td>更新时间</td><td>更新版本</td><td>更新内容</td><td>负责人</td></tr><tr><td>2023.05</td><td>V0.1</td><td>对常见问题给予说明</td><td>Ratel</td></tr><tr><td>2024.09</td><td>V0.2</td><td>增加了电量计费说明</td><td>Ratel</td></tr></table>

1、目前支持 TCP 和 MQTT 协议,推荐使用TCP协议；协议找对接人获取最新协议版本；

<font color="red">2、两个数据之间,间隔 100ms 以上,以免出现不稳定处理数据现象</font>

### 2、设备发送协议逻辑：

#### 2.1、设备发送协议逻辑

2.1.1 设备上电,等待网络连接,注册上网络后,会先发送 0x81 命令, 发送完 0x81 命令,必须回复,否则设备会持续发送登陆命令,不发送其它心跳数据；

断网重连,设备断网后,将再次发送登陆命令；走上电流程； 登陆成功后,设备即开始发送心跳命令,心跳间隔根据 81 回复命令的定义是件,上传心跳,不建议心跳时间设置太差,否则心跳数据和充电数据将采集更少的点, 不利于后期查看充电数据, 建议 60-120S, 太短浪费流量；

##### 2.1.2 远程启动 0x83 :

当用户扫码,发 83 命令开启充电；有发必回,当设备发送命令后,因网络原因,没有收到回复,应该再次发送。

0x83 命令参数说明：

<table><tr><td>名称</td><td>长度(字节)</td><td>数据类型</td><td>备注</td></tr><tr><td>端口</td><td>1</td><td>Byte</td><td>需要开启的端口号：1-N</td></tr><tr><td>订单号</td><td>4</td><td>BYTE</td><td>订单号</td></tr><tr><td>启动方式</td><td>1</td><td>BYTE</td><td>1：扫码支付 2：刷卡支付 3：管理员启动</td></tr><tr><td>卡号</td><td>4</td><td>UINT32</td><td>非 IC 卡启动,字段为 0</td></tr><tr><td>充电方式</td><td>1</td><td>BYTE</td><td>1：充满自停 2：按金额 3：按时间 4：按电量 5 : 其它</td></tr><tr><td>充电参数</td><td>4</td><td>BYTE</td><td>**秒 0.01 元 0.01 度</td></tr></table>

<table><tr><td>可用金额</td><td>4</td><td>UINT32</td><td>用户剩余金额(0.01 元)</td></tr></table>

5A A5 16 00 83 00 02 01 00 00 00 01 00 00 00 00 01 38 01 00 00 64 00 00 00 3B

启动方式：仅仅是为了记录是什么方式启动；

卡号：如果是在线卡启动,传在线卡卡号；

充电方式：

  充满自停：选择充满自停,充电参数这一项就没有不会使用,可用余额是用户的剩余金额；

  按金额充电：选择按金额充电,充电参数就是穿金额,比如充 1 元,则下发 0x64,可用余额仍然是用户的账户剩余金额

  按时间：充电参数下发多少 S,比如充 1 个小时,下发 3600 秒, 可用余额仍然是用户的账户剩余金额；

  按电量：充电参数下发 1 度电,也就是 0x64,可用余额仍然是用户的账户剩余金额；设备显示 600 分钟,也就是最大 10 小时,最多一度电,按照充满自停流程走,最后结束订单上报时候会上报使用了多少电量, 平台也可以自行计费；可用余额仍然是用户的账户剩余金额

2.1.3 在线卡逻辑：

在线卡刷卡后,将上报卡号,协议操作码会告诉是查询余额还是启动充电,若是启动充电,则走 0x83 流程,若是查询余额,或者非法卡, 按照 87 命令回复；

2.1.4、远程更改 IP,目前仅支持 TCP 协议；

更改 IP 后,设备将不在使用之前的 IP,所以必须保证 IP 正确,否则就只能手动写入；参考参数配置说明文档；

2.1.5、参数说明

浮充参考功率：浮充参考功率就是移除功率,也就是当负载低于此功率是,将走移除等待流程,所以此值建议在 10W 左右,根据实际情况,调节,如果此方式不满足低功率停机功能,需要平台根据功率曲线,做停机弥补；

开关量：0bit,此位置为充满自停开关,0,：代表设备充满自停,1： 代表关闭了充满自停,设备所有端口关闭充满自停,按照时间跑完, 空载也不会断电,根据需要使用； 充电器插入时间和充电器移除时间：设备开启充电,充电器没有功率, 等待插入时间还是没功率,将断电,如果有功率大于 3 分钟,才走移除充电时间流程；

### 3、设备计费逻辑：

设备是按照功率小时计费,0x8A 命令下发了各个档位的单价和功率档位；用户只需要根据需要设置档位,设置好后,设备会按照档位自动计费, 设备跳档位计费,有 5 分钟的稳定时间,超过 5 分钟是高档位,才回跳到高档位收费,且不会再跳回低档位,比如：设备计费是 0-100W 0.25 元/小时 101-200W 0.3 元/小时 201-300W 0.4 元 /小时, 设备一开始就是 105W, 这个时候不会按 0.3 元计费, 而是 5 分钟内按照 0.25 元计费,只有当 5 分钟后,还是 105W,设备进入二档计费,当最后设备充满,设备计费还是按照第二档收费。<font color="blue">如果不想分档计费,可以把单价设置成一样,或者档位全部设置到最高档位；</font> 如果此逻辑不满足用户需求,平台可自行根据 0x88 上传的实时功率计费。

<font color="red">0x88 命令可主动查询,设备只有在有端口充电的情况下,才会根据心跳周期,上传充电数据,如果用户想及时获取到充电数据,可以下发 0x88 查询端口充电数据；</font>

电量模式：
1、 设备支持电量+电量服务费,波峰平谷深 5 档,和电量+时间服务费,电量计费模式,必须下发 8D,来改变电量计费模式,电量计费
开关为 0 时：还是按照 8A 命令设置的参数进行时间档位计费 (以上有说明)；

开关为 1 时：启用电量加电量服务费模式,比如一端口在波段用电 0.5 度,波段电量 0.6 元一度,服务费 0.4 元一度,在谷段用了 0.8 度电,谷段电量 0.4 一度电,服务费 0.3 元一度,那么此订单总费用为0.5*（0.6+0.4）+0.8*（0.4+0.3）= 1.06 元； 
开关为 2 时：比如一端口在波段用电 0.5 度, 波段电量 0.6 元一度 (8D 命令中),在谷段用了 0.8 度电,谷段电量 0.4 一度电,总共用了 9 个小时,其中第一档用了 4 小时,第二档用了 5 小时,第一档费率为 0.2 元 1 小时, 第二档为 0.3 元一小时。那么此订单总费用为 0.5*0.6+0.8+0.4+0.2*4+0.3*5= 2.92 元；如果时间服务费不分档位,就把各档位单价设置成一样的 (8A 命令中)

### 4、协议更新问题

由于老的协议版本除了 81 自带 IMEI,其它命令都不带 IMEI,导致在服务器端因为网络波动导致连接跟设备无法及时同步,在老的协议上,增加了 C0 命令,在 82 心跳, 83 启动回复, 88 充电数据, 84 远程停止回复, 85 结束订单上报命令上发之前都会发 CO 命令告知身份, 方便及时同步连接。 或者在 81 命令登陆结果字段回复 F0 ,设备之后的<font color="red">除了81命令</font>,其它命令都按照新的协议格式,带IMEI字段。

### 5、常见问题

1、设备断电后,支持断电记忆,

2、 设备连不上网,会多次尝试重连,并重启,若因服务器崩溃,设备会再 10 分钟内重连,如果一直连不上,只能现场重启；

3、充不满问题：充不满问题可以尝试充电器移除时间调到 2 分钟以上,以便查看时间端口数据,不建议缩短。如果还有反馈,可以考虑关闭充满自停,或者远程启动 83 命令,用充电模式 5 ,那么这笔订单也不会停止,哪怕插座移除也不会停止；

4、充几个小时就停,客户说充不满,针对这个情况,可以调长充电器移除等待时间,来等待充电器再次工作。这也会导致部分客户想拔掉电源后,需要等很长时间。(两种不可兼得),可以考虑用2路独立4G插座,对这方面做了处理。